local LunarUI = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local function tween(obj, info, props)
    TweenService:Create(obj, TweenInfo.new(unpack(info)), props):Play()
end

local Notifications = Instance.new("ScreenGui")
Notifications.Name = "LunarNotifications"
Notifications.Parent = CoreGui
Notifications.ResetOnSpawn = false

local NotifContainer = Instance.new("Frame")
NotifContainer.Size = UDim2.new(0, 340, 1, 0)
NotifContainer.Position = UDim2.new(1, -360, 0, 20)
NotifContainer.BackgroundTransparency = 1
NotifContainer.Parent = Notifications

local NotifLayout = Instance.new("UIListLayout")
NotifLayout.Padding = UDim.new(0, 12)
NotifLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifLayout.Parent = NotifContainer

function LunarUI:Notify(text, duration)
    duration = duration or 4
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(0, 320, 0, 70)
    notif.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    notif.BorderSizePixel = 0
    notif.LayoutOrder = -tick()
    notif.Parent = NotifContainer
    Instance.new("UICorner", notif).CornerRadius = UDim.new(0, 16)
    local glow = Instance.new("UIStroke", notif)
    glow.Color = Color3.fromRGB(0, 180, 255)
    glow.Thickness = 2
    glow.Transparency = 0.7
    local label = Instance.new("TextLabel", notif)
    label.Text = text
    label.Font = Enum.Font.GothamSemibold
    label.TextSize = 15
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Size = UDim2.new(1, -30, 1, 0)
    label.Position = UDim2.new(0, 20, 0, 0)
    label.BackgroundTransparency = 1
    notif.Position = UDim2.new(1, 20, 0, 0)
    tween(notif, {0.5, Enum.EasingStyle.Quint}, {Position = UDim2.new(0, 0, 0, 0)})
    task.delay(duration, function()
        tween(notif, {0.5}, {Position = UDim2.new(1, 20, 0, 0)})
        task.wait(0.5)
        notif:Destroy()
    end)
end

local function MakeDraggable(frame, handle)
    local dragging, dragInput, dragStart, startPos
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end)
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            tween(frame, {0.15, Enum.EasingStyle.Quad}, {
                Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            })
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
end

local function Ripple(btn)
    local ripple = Instance.new("Frame")
    ripple.BackgroundTransparency = 0.6
    ripple.BackgroundColor3 = Color3.new(1, 1, 1)
    ripple.ZIndex = 10
    ripple.Parent = btn
    Instance.new("UICorner", ripple).CornerRadius = UDim.new(1, 0)
    local mouse = Players.LocalPlayer:GetMouse()
    ripple.Size = UDim2.new(0, 0, 0, 0)
    ripple.Position = UDim2.new(0, mouse.X - btn.AbsolutePosition.X, 0, mouse.Y - btn.AbsolutePosition.Y)
    tween(ripple, {0.4, Enum.EasingStyle.Quart}, {
        Size = UDim2.new(3, 0, 3, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        BackgroundTransparency = 1
    })
    task.delay(0.4, function() ripple:Destroy() end)
end

function LunarUI:Create(title, themeName)
    local theme = {
        Dark = {Bg=Color3.fromRGB(18,18,26), Header=Color3.fromRGB(14,14,22), Accent=Color3.fromRGB(0,170,255), Text=Color3.new(1,1,1)},
        Ocean = {Bg=Color3.fromRGB(8,14,28), Header=Color3.fromRGB(10,18,36), Accent=Color3.fromRGB(0,220,255), Text=Color3.fromRGB(200,240,255)}
    }[themeName or "Dark"]

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Parent = CoreGui
    ScreenGui.ResetOnSpawn = false

    local Main = Instance.new("Frame")
    Main.Size = UDim2.new(0, 620, 0, 420)
    Main.Position = UDim2.new(0.5, -310, 0.5, -210)
    Main.BackgroundColor3 = theme.Bg
    Main.ClipsDescendants = true
    Main.Parent = ScreenGui

    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 18)
    local Shadow = Instance.new("ImageLabel", Main)
    Shadow.Size = UDim2.new(1, 40, 1, 40)
    Shadow.Position = UDim2.new(0, -20, 0, -20)
    Shadow.BackgroundTransparency = 1
    Shadow.Image = "rbxassetid://6014261993"
    Shadow.ImageColor3 = Color3.new(0, 0, 0)
    Shadow.ImageTransparency = 0.6
    Shadow.ZIndex = -1

    local Header = Instance.new("Frame", Main)
    Header.Size = UDim2.new(1, 0, 0, 50)
    Header.BackgroundColor3 = theme.Header
    Header.BorderSizePixel = 0
    Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 18)

    local Title = Instance.new("TextLabel", Header)
    Title.Text = title or "LunarUI"
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 18
    Title.TextColor3 = theme.Text
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(0, 300, 1, 0)
    Title.Position = UDim2.new(0, 20, 0, 0)

    local Close = Instance.new("TextButton", Header)
    Close.Text = "Ã—"
    Close.Font = Enum.Font.GothamBold
    Close.TextSize = 24
    Close.TextColor3 = Color3.fromRGB(255, 80, 80)
    Close.BackgroundTransparency = 1
    Close.Size = UDim2.new(0, 50, 1, 0)
    Close.Position = UDim2.new(1, -50, 0, 0)
    Close.MouseButton1Click:Connect(function()
        tween(Main, {0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In}, {Size=UDim2.new(0,0,0,0), Position=UDim2.new(0.5,0,0.5,0)})
        task.wait(0.5)
        ScreenGui:Destroy()
    end)

    MakeDraggable(Main, Header)

    local TabSelector = Instance.new("Frame", Main)
    TabSelector.Size = UDim2.new(0, 160, 1, -60)
    TabSelector.Position = UDim2.new(0, 0, 0, 55)
    TabSelector.BackgroundTransparency = 1

    local SelectorBar = Instance.new("Frame", TabSelector)
    SelectorBar.Size = UDim2.new(0, 4, 0, 40)
    SelectorBar.BackgroundColor3 = theme.Accent
    SelectorBar.BorderSizePixel = 0
    Instance.new("UICorner", SelectorBar).CornerRadius = UDim.new(0, 4)

    local Pages = Instance.new("Folder", Main)
    local currentTab = nil

    local function CreateTab(name)
        local Button = Instance.new("TextButton", TabSelector)
        Button.Size = UDim2.new(1, -20, 0, 46)
        Button.BackgroundTransparency = 1
        Button.Text = name
        Button.Font = Enum.Font.GothamSemibold
        Button.TextSize = 15
        Button.TextColor3 = Color3.fromRGB(170, 170, 190)
        Button.TextXAlignment = Enum.TextXAlignment.Left
        Button.Position = UDim2.new(0, 20, 0, (#TabSelector:GetChildren()-1)*50)

        local Page = Instance.new("ScrollingFrame", Pages)
        Page.Size = UDim2.new(1, -170, 1, -70)
        Page.Position = UDim2.new(0, 165, 0, 60)
        Page.BackgroundTransparency = 1
        Page.ScrollBarThickness = 3
        Page.Visible = false
        Page.CanvasSize = UDim2.new(0, 0, 0, 0)

        local Layout = Instance.new("UIListLayout", Page)
        Layout.Padding = UDim.new(0, 12)
        Layout.SortOrder = Enum.SortOrder.LayoutOrder
        local Padding = Instance.new("UIPadding", Page)
        Padding.PaddingLeft = UDim.new(0, 15)
        Padding.PaddingRight = UDim.new(0, 15)
        Padding.PaddingTop = UDim.new(0, 10)

        Button.MouseButton1Click:Connect(function()
            Ripple(Button)
            if currentTab then
                tween(currentTab, {0.3}, {TextColor3 = Color3.fromRGB(170, 170, 190)})
                tween(SelectorBar, {0.4, Enum.EasingStyle.Quint}, {Position = UDim2.new(0, 8, 0, Button.AbsolutePosition.Y - TabSelector.AbsolutePosition.Y + 3)})
            end
            currentTab = Button
            tween(Button, {0.3}, {TextColor3 = Color3.new(1, 1, 1)})
            for _, p in pairs(Pages:GetChildren()) do p.Visible = false end
            Page.Visible = true
        end)

        if not currentTab then
            currentTab = Button
            Button.TextColor3 = Color3.new(1, 1, 1)
            Page.Visible = true
            SelectorBar.Position = UDim2.new(0, 8, 0, Button.AbsolutePosition.Y - TabSelector.AbsolutePosition.Y + 3)
        end

        local Section = {}

        function Section:Button(text, callback)
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 46)
            btn.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            btn.Text = text
            btn.Font = Enum.Font.Gotham
            btn.TextSize = 14
            btn.TextColor3 = theme.Text
            btn.Parent = Page
            Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 12)
            btn.MouseButton1Click:Connect(function()
                Ripple(btn)
                task.spawn(callback)
            end)
            btn.MouseEnter:Connect(function() tween(btn, {0.2}, {BackgroundColor3 = Color3.fromRGB(40, 40, 55)}) end)
            btn.MouseLeave:Connect(function() tween(btn, {0.2}, {BackgroundColor3 = Color3.fromRGB(30, 30, 42)}) end)
        end

        function Section:Toggle(text, default, callback)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 0, 46)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            frame.Parent = Page
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

            local label = Instance.new("TextLabel", frame)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 14
            label.TextColor3 = theme.Text
            label.Size = UDim2.new(1, -70, 1, 0)
            label.Position = UDim2.new(0, 16, 0, 0)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local switch = Instance.new("Frame")
            switch.Size = UDim2.new(0, 50, 0, 28)
            switch.Position = UDim2.new(1, -66, 0.5, -14)
            switch.BackgroundColor3 = Color3.fromRGB(70, 70, 80)
            switch.Parent = frame
            Instance.new("UICorner", switch).CornerRadius = UDim.new(0, 14)

            local circle = Instance.new("Frame")
            circle.Size = UDim2.new(0, 24, 0, 24)
            circle.Position = default and UDim2.new(1, -28, 0.5, -12) or UDim2.new(0, 4, 0.5, -12)
            circle.BackgroundColor3 = Color3.new(1, 1, 1)
            circle.Parent = switch
            Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)

            local enabled = default or false
            if enabled then
                switch.BackgroundColor3 = theme.Accent
            end

            frame.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    enabled = not enabled
                    tween(switch, {0.25}, {BackgroundColor3 = enabled and theme.Accent or Color3.fromRGB(70,70,80)})
                    tween(circle, {0.25}, {Position = enabled and UDim2.new(1,-28,0.5,-12) or UDim2.new(0,4,0.5,-12)})
                    if callback then callback(enabled) end
                end
            end)
        end

        function Section:Slider(text, min, max, default, callback)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 0, 66)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            frame.Parent = Page
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

            local label = Instance.new("TextLabel", frame)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 14
            label.TextColor3 = theme.Text
            label.Size = UDim2.new(1, -100, 0, 30)
            label.Position = UDim2.new(0, 16, 0, 6)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local valueLabel = Instance.new("TextLabel", frame)
            valueLabel.Text = tostring(default or min)
            valueLabel.Font = Enum.Font.GothamBold
            valueLabel.TextColor3 = theme.Accent
            valueLabel.Size = UDim2.new(0, 80, 0, 30)
            valueLabel.Position = UDim2.new(1, -96, 0, 6)
            valueLabel.BackgroundTransparency = 1

            local bar = Instance.new("Frame")
            bar.Size = UDim2.new(1, -32, 0, 8)
            bar.Position = UDim2.new(0, 16, 0, 44)
            bar.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
            bar.Parent = frame
            Instance.new("UICorner", bar).CornerRadius = UDim.new(0, 4)

            local fill = Instance.new("Frame")
            fill.Size = UDim2.new((default-min)/(max-min), 0, 1, 0)
            fill.BackgroundColor3 = theme.Accent
            fill.Parent = bar
            Instance.new("UICorner", fill).CornerRadius = UDim.new(0, 4)

            local knob = Instance.new("Frame")
            knob.Size = UDim2.new(0, 20, 0, 20)
            knob.Position = UDim2.new(fill.Size.X.Scale, 0, 0.5, 0)
            knob.AnchorPoint = Vector2.new(0.5, 0.5)
            knob.BackgroundColor3 = Color3.new(1, 1, 1)
            knob.Parent = bar
            Instance.new("UICorner", knob).CornerRadius = UDim.new(1, 0)

            local dragging = false
            bar.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dragging = true end end)
            UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dragging = false end end)
            UserInputService.InputChanged:Connect(function(i)
                if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
                    local rel = math.clamp((i.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
                    local val = math.floor(min + (max - min) * rel)
                    fill.Size = UDim2.new(rel, 0, 1, 0)
                    knob.Position = UDim2.new(rel, 0, 0.5, 0)
                    valueLabel.Text = tostring(val)
                    if callback then callback(val) end
                end
            end)
        end

        function Section:Dropdown(text, items, default, callback)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 0, 46)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            frame.Parent = Page
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

            local label = Instance.new("TextLabel", frame)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 14
            label.TextColor3 = theme.Text
            label.Size = UDim2.new(1, -140, 1, 0)
            label.Position = UDim2.new(0, 16, 0, 0)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local selected = Instance.new("TextLabel", frame)
            selected.Text = default or items[1] or "Select"
            selected.Font = Enum.Font.GothamBold
            selected.TextColor3 = theme.Accent
            selected.Size = UDim2.new(0, 120, 1, 0)
            selected.Position = UDim2.new(1, -140, 0, 0)
            selected.BackgroundTransparency = 1
            selected.TextXAlignment = Enum.TextXAlignment.Right

            local arrow = Instance.new("TextLabel", frame)
            arrow.Text = "Down Arrow"
            arrow.Rotation = 0
            arrow.Font = Enum.Font.GothamBold
            arrow.TextColor3 = Color3.fromRGB(200, 200, 200)
            arrow.Size = UDim2.new(0, 30, 1, 0)
            arrow.Position = UDim2.new(1, -30, 0, 0)
            arrow.BackgroundTransparency = 1

            local list = Instance.new("Frame")
            list.Size = UDim2.new(1, -32, 0, 0)
            list.Position = UDim2.new(0, 16, 1, 8)
            list.BackgroundColor3 = Color3.fromRGB(26, 26, 38)
            list.Visible = false
            list.Parent = frame
            Instance.new("UICorner", list).CornerRadius = UDim.new(0, 12)
            local listLayout = Instance.new("UIListLayout", list)
            listLayout.Padding = UDim.new(0, 4)

            local open = false
            local height = #items * 40 + 16

            for _, item in ipairs(items) do
                local opt = Instance.new("TextButton", list)
                opt.Size = UDim2.new(1, 0, 0, 40)
                opt.BackgroundTransparency = 1
                opt.Text = "   "..item
                opt.TextColor3 = Color3.fromRGB(200, 200, 220)
                opt.Font = Enum.Font.Gotham
                opt.TextXAlignment = Enum.TextXAlignment.Left
                opt.MouseButton1Click:Connect(function()
                    selected.Text = item
                    if callback then callback(item) end
                    open = false
                    tween(arrow, {0.3}, {Rotation = 0})
                    tween(list, {0.4, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,-32,0,0)})
                    tween(frame, {0.5, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,0,0,46)})
                    task.wait(0.1)
                    list.Visible = false
                end)
            end

            frame.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    open = not open
                    list.Visible = true
                    if open then
                        tween(arrow, {0.3}, {Rotation = 180})
                        tween(frame, {0.5, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,0,0,46 + height)})
                        tween(list, {0.4, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,-32,0,height)})
                    else
                        tween(arrow, {0.3}, {Rotation = 0})
                        tween(list, {0.4, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,-32,0,0)})
                        tween(frame, {0.5, Enum.EasingStyle.Quint}, {Size = UDim2.new(1,0,0,46)})
                    end
                end
            end)
        end

        function Section:Keybind(text, defaultKey, callback)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 0, 46)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            frame.Parent = Page
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

            local label = Instance.new("TextLabel", frame)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 14
            label.TextColor3 = theme.Text
            label.Size = UDim2.new(1, -100, 1, 0)
            label.Position = UDim2.new(0, 16, 0, 0)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local bind = Instance.new("TextButton", frame)
            bind.Text = defaultKey and defaultKey.Name or "None"
            bind.Font = Enum.Font.GothamBold
            bind.TextColor3 = theme.Accent
            bind.Size = UDim2.new(0, 80, 0, 30)
            bind.Position = UDim2.new(1, -96, 0.5, -15)
            bind.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
            bind.AutoButtonColor = false
            Instance.new("UICorner", bind).CornerRadius = UDim.new(0, 8)

            local listening = false
            bind.MouseButton1Click:Connect(function()
                bind.Text = "..."
                listening = true
            end)
            UserInputService.InputBegan:Connect(function(input)
                if listening and input.KeyCode ~= Enum.KeyCode.Unknown then
                    bind.Text = input.KeyCode.Name
                    listening = false
                    if callback then callback(input.KeyCode) end
                end
            end)
        end

        function Section:ColorPicker(text, default, callback)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 0, 46)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
            frame.Parent = Page
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

            local label = Instance.new("TextLabel", frame)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 14
            label.TextColor3 = theme.Text
            label.Size = UDim2.new(1, -70, 1, 0)
            label.Position = UDim2.new(0, 16, 0, 0)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local preview = Instance.new("Frame")
            preview.Size = UDim2.new(0, 34, 0, 34)
            preview.Position = UDim2.new(1, -50, 0.5, -17)
            preview.BackgroundColor3 = default or Color3.new(1, 1, 1)
            preview.Parent = frame
            Instance.new("UICorner", preview).CornerRadius = UDim.new(0, 8)
            Instance.new("UIStroke", preview).Color = Color3.fromRGB(100, 100, 100)

            preview.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    local hue = tick() % 1
                    local color = Color3.fromHSV(hue, 1, 1)
                    preview.BackgroundColor3 = color
                    if callback then callback(color) end
                end
            end)
        end

        Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Page.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 30)
        end)

        return Section
    end

    Main.Size = UDim2.new(0, 0, 0, 0)
    tween(Main, {0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out}, {
        Size = UDim2.new(0, 620, 0, 420),
        Position = UDim2.new(0.5, -310, 0.5, -210)
    })

    UserInputService.InputBegan:Connect(function(inp)
        if inp.KeyCode == Enum.KeyCode.RightShift then
            Main.Visible = not Main.Visible
            if Main.Visible then
                tween(Main, {0.4}, {Size = UDim2.new(0, 620, 0, 420)})
            else
                tween(Main, {0.4}, {Size = UDim2.new(0, 0, 0, 0)})
            end
        end
    end)

    return {
        Tab = CreateTab,
        Notify = LunarUI.Notify
    }
end

return LunarUI
